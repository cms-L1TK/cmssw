name: Mirror and run GitLab CI

on: # Controls when the action will run.
  workflow_dispatch:
  push: # Please add your branch down here if you want CI to run for each push to it.
    branches: [ianCI]
  pull_request: # Run CI if someone makes a PR to default branch.
    branches: [L1TK-dev-12_0_0_pre4]
    
env:
  mirror_repo: "https://gitlab.cern.ch/cms-l1tk/cmssw" # gitlab mirror
  current_branch: "unitialized"

jobs:
  mirror_trig: # https://github.com/marketplace/actions/mirror-to-gitlab-and-run-gitlab-ci
    name: mirror_trig
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: Debug
      run: |
        echo "github.ref = ${{ github.ref }}"
    - name: Redefine branch on pull_request
      if: github.event_name == 'pull_request'
      run: |
        # Sets env. variable $current_branch
        echo "current_branch=$(echo ${{ github.head_ref }})" >> $GITHUB_ENV
    - name: Redefine branch on push
      if: github.event_name == 'push'
      run: |
        # Sets env. variable $current_branch
        echo "current_branch=$(echo ${{ github.ref }} | sed -E 's|refs/[a-zA-Z]+/||')" >> $GITHUB_ENV
    - name: Mirror + trigger CI
      # Forked from https://github.com/SvanBoxel/gitlab-mirror-and-ci-action .
      #uses: aperloff/gitlab-mirror-and-ci-action@master
      uses: cms-L1TK/gitlab-mirror-and-ci-action@master
#      with:
#        args: "https://gitlab.cern.ch/tomalin/cmssw" # mirror repo
      env:
        GITLAB_HOSTNAME: "gitlab.cern.ch"
#        GITLAB_USERNAME: "tomalin"
        GITLAB_USERNAME: "cms-l1tk"
#        GITLAB_PASSWORD: ${{ secrets.GITLAB_PASSWORD }} # Generate token here: https://gitlab.cern.ch/tomalin/cmssw/-/settings/access_tokens and add it to GitHub secrets https://github.com/cms-L1TK/cmssw/settings/secrets/actions   
        GITLAB_PASSWORD: ${{ secrets.GITLAB_L1TK_CMSSW_CI_TOKEN }} # Generate token here: https://gitlab.cern.ch/cms-l1tk/cmssw_CI/-/settings/access_tokens and add it to GitHub secrets https://github.com/cms-L1TK/cmssw/settings/secrets/actions   
#        GITLAB_PROJECT_ID: "124554" # ID visible at https://gitlab.cern.ch/tomalin/cmssw 
        GITLAB_PROJECT_ID: "124851" # ID visible at https://gitlab.cern.ch/cms-l1tk/cmssw 
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # https://help.github.com/en/articles/virtual-environments-for-github-actions#github_token-secret
        MIRROR_REPO: ${{ env.mirror_repo }} # gitlab mirror.
        CHECKOUT_BRANCH: ${{ env.current_branch }} # Needed so push to gitlab can work
        REMOVE_BRANCH: "true" # Refreshes branch on mirror, which triggers CI run there.
        REBASE_MASTER: "false" # If true would rebase to "master", which isn't used in cms-L1TK.
        RETURN_FILE: "pipeline_url.txt" # Output file with gitlab pipeline url
    - name: print summary
      run: |
        echo "==========================================================="
        echo "Detailed output from CMSSW compilation & run can be found"
        echo "in the following gitlab CI url"
        cat pipeline_url.txt
